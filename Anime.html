<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Om Yudz ‚Äî Nonton Anime Sub Indo</title>
  <style>
    :root{
      --bg:#0a0a0a; --panel:#111; --line:#00ffff; --text:#e8ffff;
      --muted:#a7e7e7; --danger:#ff3b3b; --success:#00d68f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

    /* HEADER */
    header{
      position:sticky;top:0;z-index:60;
      display:flex;align-items:center;gap:12px;justify-content:space-between;
      background:linear-gradient(180deg,#0f0f10,#0a0a0a 90%);
      padding:12px 16px;border-bottom:1px solid rgba(0,255,255,.15);
      box-shadow:0 6px 24px rgba(0,255,255,.08);
    }
    .brand{display:flex;align-items:center;gap:12px}
    header img{height:44px;width:44px;border-radius:50%;border:2px solid rgba(0,255,255,.35)}
    header h1{margin:0;font-size:16px;letter-spacing:.4px;color:var(--text)}
    .userbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,255,255,.3);
      background:#0f1112; color:var(--text)
    }
    .btn{
      padding:8px 12px;border-radius:10px;border:1px solid rgba(0,255,255,.35);
      background:var(--line);color:#002;font-weight:700;cursor:pointer
    }
    .btn.outline{background:transparent;color:var(--text)}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .btn.success{background:var(--success);border-color:transparent;color:#001}

    /* SEARCH */
    .search{ max-width:1100px;margin:16px auto 0;padding:0 16px 8px; }
    .search input{
      width:100%;padding:12px 14px;border-radius:10px;border:2px solid rgba(0,255,255,.35);
      background:#0f0f10;color:var(--text);font-size:15px;outline:none;
      box-shadow:0 0 0 2px transparent;transition:.2s;
    }
    .search input:focus{box-shadow:0 0 0 2px rgba(0,255,255,.25)}

    /* PLAYER */
    .player-wrap{display:flex;justify-content:center}
    .player{
      width:100%;max-width:1000px;margin:18px auto;padding:10px 16px;
      border:1px solid rgba(0,255,255,.25);border-radius:14px;background:rgba(17,17,17,.9);
      box-shadow:0 12px 40px rgba(0,255,255,.10), inset 0 0 0 1px rgba(0,255,255,.08);
    }
    .player iframe{
      width:100%;aspect-ratio:16/9;border:0;border-radius:10px;background:#000;
      box-shadow:0 0 0 2px rgba(0,255,255,.25);
    }
    .player h2{margin:12px 4px 0;font-size:16px;color:var(--muted);font-weight:600}

    /* GRID ala Netflix */
    .grid{
      max-width:1200px;margin:8px auto 32px;padding:0 16px;
      display:grid;gap:16px;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
    }
    @media(min-width:720px){ .grid{gap:18px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));} }
    @media(min-width:1024px){ .grid{gap:20px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));} }

    .card{
      position:relative;overflow:hidden;border-radius:12px;background:var(--panel);
      border:1px solid rgba(0,255,255,.14);box-shadow:0 10px 24px rgba(0,0,0,.35);
      transform:translateZ(0);transition:transform .2s, box-shadow .2s, border-color .2s;
      cursor:pointer;
    }
    .card:hover{transform:scale(1.04);border-color:rgba(0,255,255,.35);box-shadow:0 16px 40px rgba(0,255,255,.15)}
    .poster{width:100%;aspect-ratio:2/3;object-fit:cover;display:block}

    /* Overlay info bawah poster */
    .info{
      position:absolute;inset:auto 0 0 0;padding:10px 10px 12px;
      background:linear-gradient(180deg,transparent 0%, rgba(0,0,0,.65) 40%, rgba(0,0,0,.85) 100%);
      color:#fff;
    }
    .title{margin:0 0 6px;font-size:14px;font-weight:700}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{
      font-size:11px;line-height:1;padding:6px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.35);backdrop-filter:blur(2px)
    }
    .badge.rating{border-color:rgba(0,255,160,.4)}

    /* MODAL umum */
    .modal{display:none;position:fixed;z-index:120;inset:0;background:rgba(0,0,0,.88);
      align-items:center;justify-content:center;padding:16px}
    .modal-content{
      width:100%;max-width:480px;background:#101012;border:1px solid rgba(0,255,255,.25);
      border-radius:14px;padding:18px;box-shadow:0 18px 60px rgba(0,255,255,.15);animation:pop .18s ease;
      max-height:80vh;overflow-y:auto;
    }
    @keyframes pop{from{transform:scale(.96);opacity:.6}to{transform:scale(1);opacity:1}}
    .modal-content h3{margin:0 0 10px;font-size:18px}
    .modal .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .close{display:inline-block;margin-top:8px;padding:8px 12px;border-radius:10px;background:var(--danger);color:#fff;cursor:pointer}

    /* List episode */
    .episode-list a{
      display:block;padding:10px 12px;margin:8px 0;border-radius:10px;text-decoration:none;
      background:#17181a;color:var(--text);border:1px solid rgba(0,255,255,.2)
    }
    .episode-list a:hover{background:#0f1214;border-color:rgba(0,255,255,.35)}

    /* Modal iklan */
    .ad-box{display:flex;align-items:center;justify-content:center}
    .ad-box img,.ad-box video{max-width:100%;max-height:60vh;border-radius:12px;border:1px solid rgba(0,255,255,.25)}

    .hide{display:none!important}

    @media(max-width:480px){
      header h1{font-size:13px}
      .btn{padding:6px 10px;font-size:13px}
      .pill{font-size:11px;padding:4px 8px}
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="brand">
      <img src="https://files.catbox.moe/eer4qt.png" alt="Logo"/>
      <h1>[ ÊπØÁî∞ ] Yuda ‚Ä¢ Anime Sub Indo</h1>
    </div>

    <div class="userbar" id="userBar">
      <!-- diisi via JS (status user, keys, tombol login/register/upgrade/logout) -->
    </div>
  </header>

  <!-- SEARCH -->
  <div class="search">
    <input id="searchInput" type="text" placeholder="Cari anime, genre‚Ä¶ (misal: action, romance, school)"/>
  </div>

  <!-- PLAYER -->
  <div class="player-wrap">
    <div class="player" id="playerBox">
      <iframe id="player" src="" allow="autoplay" allowfullscreen></iframe>
      <h2 id="judul">üé¨ Pilih Anime & Episode, Dengan Kualitas -- ( 360p ~ 720p ~ 1080p )</h2>

      <div style="text-align:center;margin-top:10px;">
        üòÑüòÑüòÑüòÑüòÑüòÑüòÑüòÑüòÑüòÑ
        <p style="font-size:13px;color:#aaa;margin-top:5px;">
          üì± DISARANKAN PUTAR LAYAR KE LANDSCAPE AGAR LEBIH NYAMAN
        </p>
      </div>
    </div>
  </div>

  <!-- GRID / DAFTAR ANIME -->
  <div class="grid" id="animeList">
    <!-- CARD 1 -->
    <div class="card" data-title="Our Dating Story: The Experienced You and The Inexperienced Me" data-genre="Romance, School" onclick="openModal('kak')">
      <img class="poster" src="https://github.com/YudaTole/Data-Anime/raw/refs/heads/main/Our%20Dating%20Story_The%20Experienced%20You%20and%20The%20Inexperienced%20Me.jpeg" alt="Our Dating Story: The Experienced You and The Inexperienced Me"/>
      <div class="info">
        <h3 class="title">Our Dating Story: The Experienced You and The Inexperienced Me</h3>
        <div class="badges">
          <span class="badge">Romance</span>
          <span class="badge">School</span>
          <span class="badge rating">‚≠ê 6.76</span>
        </div>
        <button class="btn" onclick="event.stopPropagation();openModal('kak')">Pilih Episode</button>
      </div>
    </div>

    <!-- CARD 2 -->
    <div class="card" data-title="Mato Seihei No Slave" data-genre="Action, Fantasy" onclick="openModal('msns')">
      <img class="poster" src="https://github.com/YudaTole/Data-Anime/raw/refs/heads/main/Mato%20Seihei%20no%20Slave.png" alt="Mato Seihei No Slave"/>
      <div class="info">
        <h3 class="title">Mato Seihei No Slave</h3>
        <div class="badges">
          <span class="badge">Action</span>
          <span class="badge">Fantasy</span>
          <span class="badge rating">‚≠ê 6.85</span>
        </div>
        <button class="btn" onclick="event.stopPropagation();openModal('msns')">Pilih Episode</button>
      </div>
    </div>

    <!-- CARD 3 -->
    <div class="card" data-title="The Angel Next Door Spoils Me Rotten" data-genre="School, Romance" onclick="openModal('tan')">
      <img class="poster" src="https://github.com/YudaTole/Data-Anime/raw/refs/heads/main/The%20Angel%20Next%20Door%20Spoils%20Me%20Rotten.jpg" alt="The Angel Next Door Spoils Me Rotten"/>
      <div class="info">
        <h3 class="title">The Angel Next Door Spoils Me Rotten</h3>
        <div class="badges">
          <span class="badge">School</span>
          <span class="badge">Romance</span>
          <span class="badge rating">‚≠ê 7.85</span>
        </div>
        <button class="btn" onclick="event.stopPropagation();openModal('tan')">Pilih Episode</button>
      </div>
    </div>

    <!-- CARD 4 -->
    <div class="card" data-title="The Aristocrat's Otherworldly Adventure: Serving Gods Who Go Too Far" data-genre="Action, Isekai" onclick="openModal('tao')">
      <img class="poster" src="https://github.com/YudaTole/Data-Anime/raw/refs/heads/main/The%20Aristocrat's%20Otherworldly%20Adventure%20Serving%20Gods%20Who%20Go%20Too%20Far.png" alt="The Aristocrat's Otherworldly Adventure: Serving Gods Who Go Too Far"/>
      <div class="info">
        <h3 class="title">The Aristocrat's Otherworldly Adventure: Serving Gods Who Go Too Far</h3>
        <div class="badges">
          <span class="badge">Action</span>
          <span class="badge">Isekai</span>
          <span class="badge rating">‚≠ê 6.68</span>
        </div>
        <button class="btn" onclick="event.stopPropagation();openModal('tao')">Pilih Episode</button>
      </div>
    </div>
  </div>

  <!-- ================== MODALS ================== -->

  <!-- LOGIN / REGISTER -->
  <div id="modal-auth" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3 id="authTitle">Masuk / Daftar</h3>
      <div>
        <label>Username</label>
        <input id="authUser" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid rgba(0,255,255,.25);background:#0f1112;color:#fff" placeholder="mis: yuda">
      </div>
      <div style="margin-top:10px">
        <label>Password</label>
        <input id="authPass" type="password" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid rgba(0,255,255,.25);background:#0f1112;color:#fff" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="btn outline" onclick="doRegister()">Register</button>
        <div class="close" onclick="closeModal('auth')">Tutup</div>
      </div>
      <p style="color:#aab; font-size:12px; margin-top:6px;">* Demo: akun disimpan di perangkat ini (localStorage).</p>
    </div>
  </div>

  <!-- PILIHAN JIKA KUNCI HABIS (BASIC) -->
  <div id="modal-need-keys" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>Kunci kamu habis</h3>
      <p style="margin:8px 0 12px;color:#a7e7e7">Pilih salah satu:</p>
      <div class="actions">
        <button class="btn" id="btnWatchAd3">Tonton Iklan (+3 kunci)</button>
        <button class="btn success" onclick="openModal('upgrade')">Dapatkan Kunci</button>
      </div>
      <div class="close" onclick="closeModal('need-keys')">Tutup</div>
    </div>
  </div>

  <!-- DAPATKAN KUNCI (PAKET + IKLAN DURASI) -->
  <div id="modal-upgrade" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>Dapatkan Kunci üîë dengan Nonton Iklan</h3>
      <p style="margin:6px 0 10px;color:#a7e7e7">Pilih paket & tonton iklan sesuai durasi:</p>
      <div class="actions">
        <button class="btn" onclick="startPackageAd(12,15)">12 Key (15s)</button>
        <button class="btn" onclick="startPackageAd(15,30)">15 Key (30s)</button>
        <button class="btn" onclick="startPackageAd(25,45)">25 Key (45s)</button>
        <button class="btn" onclick="startPackageAd(30,60)">30 Key (60s)</button>
      </div>
      <div class="close" onclick="closeModal('upgrade')">Batal</div>
      <p style="color:#aab; font-size:12px; margin-top:6px;">* Demo: tidak ada pembayaran, hanya menonton iklan.</p>
    </div>
  </div>

  <!-- MODAL IKLAN (RANDOM FOTO/VIDEO) -->
  <div id="modal-ad" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>Iklan</h3>
      <div id="adBox" class="ad-box" style="margin-top:8px"></div>
      <p id="adHint" style="color:#aab; font-size:12px; margin-top:8px;text-align:center"></p>
      <p id="adTimer" style="text-align:center;margin-top:6px"></p>
      <div class="actions" id="adActions" style="justify-content:center"></div>
    </div>
  </div>

  <!-- ================== MODALS EPISODE ================== -->

  <!-- Our Dating Story -->
  <div id="modal-kak" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>Our Dating Story</h3>
      <div class="episode-list">
        <a onclick="requestPlay('https://drive.google.com/file/d/1Cdk5BaA8d2-_6OosH4XqIJJyf3Qml6v_/preview','Our Dating Story - Episode 1')">Episode 1</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1GpndMciylAVXFVRyVEH0lgkI4AoHGvq3/preview','Our Dating Story - Episode 2')">Episode 2</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1Gzj3_-Xu2zuXvWJI2RzofPxCPwokSQzV/preview','Our Dating Story - Episode 3')">Episode 3</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1Gyqbeft3rUjvtdyHKDtxALm7QwO2fasQ/preview','Our Dating Story - Episode 4')">Episode 4</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1GwOSwm-c5AdJkYalF8p_GnOYl0YK1c2i/preview','Our Dating Story - Episode 5')">Episode 5</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1GqFq5C2ZcsmPFrAtubQNmpcffTNQ-rI9/preview','Our Dating Story - Episode 6')">Episode 6</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1HE3MwS12pNnszIMyeI2fEhppI_KQGLpa/preview','Our Dating Story - Episode 7')">Episode 7</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1H3-e86mr7tYa6OuaD719SksAWUwSEQ2h/preview','Our Dating Story - Episode 8')">Episode 8</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1H0BOZ9tVzB3_o3-gxhJ0zG3ZbOxRQvR3/preview','Our Dating Story - Episode 9')">Episode 9</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1H-mJREK2OFnKcWi0W6B7fe_iHQQUVAzq/preview','Our Dating Story - Episode 10')">Episode 10</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1HMbQbbrkY3MxQJdNx89yds0ubjq455l4/preview','Our Dating Story - Episode 11')">Episode 11</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1HERsLkKHtm4A1v57V4DTOg1ztMk7o0E3/preview','Our Dating Story - Episode 12 END')">Episode 12 END</a>
      </div>
      <div class="close" onclick="closeModal('kak')">Tutup</div>
    </div>
  </div>

  <!-- MATO SEIHEI NO SLAVE -->
  <div id="modal-msns" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>Mato Seihei No Slave</h3>
      <div class="episode-list">
        <a onclick="requestPlay('https://drive.google.com/file/d/1FFgrhfvhiqzzCZu1wdSbLs9YpKXIi5Dp/preview','Mato Seihei No Slave - Episode 1')">Episode 1</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1FduwoMcwWSr5by54TXuVQKgGg2T5UVcV/preview','Mato Seihei No Slave - Episode 2')">Episode 2</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1FeMw5GZy5ChuROR8zQwQlm0MP_mOf664/preview','Mato Seihei No Slave - Episode 3')">Episode 3</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1FmKGtB8MLKjcwSPm9beorBu2JX9yuZSX/preview','Mato Seihei No Slave - Episode 4')">Episode 4</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1Fk1-JgF_JbCRaMbPYjhUnDDkFhRZz_Y7/preview','Mato Seihei No Slave - Episode 5')">Episode 5</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1FoFAAkhc89XShCv77avQzrTsT2JHxB8B/preview','Mato Seihei No Slave - Episode 6')">Episode 6</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1GE_jjyAuNgYMRbsyGwHbQ02J-60Z6ygh/preview','Mato Seihei No Slave - Episode 7')">Episode 7</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1GM0-KIs5CTCXnOmN2iLBt5IhIMds_KgW/preview','Mato Seihei No Slave - Episode 8')">Episode 8</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1GEtXX4z2gDGK99y4ehKoBZuCHsgipMHX/preview','Mato Seihei No Slave - Episode 9')">Episode 9</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1FMbxzvAgkAitpvAPBxRfs5DCUsDwmCWP/preview','Mato Seihei No Slave - Episode 10')">Episode 10</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1FWIyR6QlEhMEZGvKgg5t7WLAt3-Qxi40/preview','Mato Seihei No Slave - Episode 11')">Episode 11</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1FZt7Ohfg3crWUhrbkWlxHP8h0nxpYRFO/preview','Mato Seihei No Slave - Episode 12 END')">Episode 12 END</a>
      </div>
      <div class="close" onclick="closeModal('msns')">Tutup</div>
    </div>
  </div>

  <!-- The Angel Next Door -->
  <div id="modal-tan" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>The Angel Next Door Spoils Me Rotten</h3>
      <div class="episode-list">
        <a onclick="requestPlay('https://drive.google.com/file/d/1DpWAoii9JpYAhSKJ1K9qHLoX1bLbCbdx/preview','The Angel Next Door - Episode 1')">Episode 1</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1DudGAaSx8WFewCrhihw8xvbD8wgdzO2_/preview','The Angel Next Door - Episode 2')">Episode 2</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1Eml3iSTc3rzUwozNi0f-p4XsVPDik0qp/preview','The Angel Next Door - Episode 3')">Episode 3</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1EKJ1k-6n7jyAnhDMT4MGFukxiA_rBKTb/preview','The Angel Next Door - Episode 4')">Episode 4</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1EhOE7sIxTV-bcApOou1cUZltY1FTSbZC/preview','The Angel Next Door - Episode 5')">Episode 5</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1DxuRnp10cT3DVkR1UjF2H4EEZyp-s_97/preview','The Angel Next Door - Episode 6')">Episode 6</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1E3GD5b5BxaEGI105b2j2xrcPmpIdpA-n/preview','The Angel Next Door - Episode 7')">Episode 7</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1EHYhJsTF2gg3bNCtMLq93pI1DZYpmbaX/preview','The Angel Next Door - Episode 8')">Episode 8</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1EL4EQ8pn5yrPWD-KvOY0kNYK0UGq97o9/preview','The Angel Next Door - Episode 9')">Episode 9</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1EeQAZZB_tGCcja--d_r4OE84lW7ra0dy/preview','The Angel Next Door - Episode 10')">Episode 10</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1EgMIPHTz6YmI5lMPcydbahPyVMeqRSLB/preview','The Angel Next Door - Episode 11')">Episode 11</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1EiKrpgumy30mrE2UM3T_d8TmdCvXFvjQ/preview','The Angel Next Door - Episode 12 END')">Episode 12 END</a>
      </div>
      <div class="close" onclick="closeModal('tan')">Tutup</div>
    </div>
  </div>

  <!-- The Aristocrat's Otherworldly Adventure -->
  <div id="modal-tao" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>The Aristocrat's Otherworldly Adventure</h3>
      <div class="episode-list">
        <a onclick="requestPlay('https://drive.google.com/file/d/1GkwVOgH1uPoI3Aj9Rbxp2lw03-864x93/preview','Aristocrat Adventure - Episode 1')">Episode 1</a>
        <a onclick="requestPlay('https://drive.google.com/file/d/1GislNP02kfeIG9vOpnlMdF45pr-Etz5W/preview','Aristocrat Adventure - Episode 2')">Episode 2</a>
      </div>
      <div class="close" onclick="closeModal('tao')">Tutup</div>
    </div>
  </div>

  <script>
    /* =========================
       UTIL & STORAGE
       ========================= */
    const LS_USERS = "oy_users";      // map username -> {password, role, keys}
    const LS_USER  = "oy_currentUser"; // string username yang sedang login

    function getUsers(){
      return JSON.parse(localStorage.getItem(LS_USERS) || "{}");
    }
    function setUsers(obj){
      localStorage.setItem(LS_USERS, JSON.stringify(obj));
    }
    function getCurrentUsername(){
      return localStorage.getItem(LS_USER) || null;
    }
    function setCurrentUsername(u){
      if(u) localStorage.setItem(LS_USER, u); else localStorage.removeItem(LS_USER);
    }
    function getCurrentUserObj(){
      const u = getCurrentUsername(); if(!u) return null;
      const users = getUsers(); return users[u] || null;
    }
    function saveCurrentUserObj(updater){
      const u = getCurrentUsername(); if(!u) return;
      const users = getUsers();
      users[u] = updater(users[u]);
      setUsers(users);
      renderUserBar();
    }

    /* =========================
       AUTH (LOGIN / REGISTER)
       ========================= */
    function openModal(id){ const el = document.getElementById('modal-'+id); if(el){ el.style.display='flex'; el.focus?.(); } }
    function closeModal(id){ const el = document.getElementById('modal-'+id); if(el){ el.style.display='none'; } }

    function openAuth(){ openModal('auth'); }
    function doLogin(){
      const uname = document.getElementById('authUser').value.trim();
      const pass  = document.getElementById('authPass').value;
      const users = getUsers();
      if(!users[uname]){ alert("Akun tidak ditemukan. Silakan register."); return; }
      if(users[uname].password !== pass){ alert("Password salah."); return; }
      setCurrentUsername(uname);
      closeModal('auth');
      renderUserBar();
      alert("Login berhasil. Selamat datang, " + uname + "!");
    }
    function doRegister(){
      const uname = document.getElementById('authUser').value.trim();
      const pass  = document.getElementById('authPass').value;
      if(!uname || !pass){ alert("Username & Password wajib diisi."); return; }
      const users = getUsers();
      if(users[uname]){ alert("Username sudah dipakai. Coba yang lain."); return; }
      users[uname] = { password: pass, role: "basic", keys: 3 }; // user baru: basic & 3 kunci awal
      setUsers(users);
      setCurrentUsername(uname);
      closeModal('auth');
      renderUserBar();
      alert("Register berhasil. Kamu mendapat 3 kunci.");
    }
    function logout(){ setCurrentUsername(null); renderUserBar(); }

    function renderUserBar(){
      const bar = document.getElementById('userBar');
      const u = getCurrentUserObj();
      if(!u){
        bar.innerHTML = `
          <span class="pill">Belum login</span>
          <button class="btn outline" onclick="openAuth()">Login / Register</button>
        `;
        return;
      }
      const username = getCurrentUsername();
      const keys = u.keys ?? 0;
      bar.innerHTML = `
        <span class="pill">üë§ ${username}</span>
        <span class="pill">üîë Key: ${keys}</span>
        <button class="btn success" onclick="openModal('upgrade')">Dapatkan Kunci</button>
        <button class="btn danger" onclick="logout()">Logout</button>
      `;
    }

    /* =========================
       IKLAN RANDOM (POOL)
       ========================= */
    const AD_POOL = [
      { type: 'image', url: "https://github.com/YudaTole/Data-Anime/raw/refs/heads/main/The%20Aristocrat's%20Otherworldly%20Adventure%20Serving%20Gods%20Who%20Go%20Too%20Far.png" },
      { type: 'video', url: "https://github.com/YudaTole/My-video/raw/refs/heads/main/Animals%20%F0%9F%A5%B6.mp4" },
      { type: 'image', url: "https://picsum.photos/800/450?random=1" },
      { type: 'image', url: "https://picsum.photos/800/450?random=2" },
      { type: 'video', url: "https://www.w3schools.com/html/mov_bbb.mp4" }
    ];

    function pickRandomAd(){
      return AD_POOL[Math.floor(Math.random() * AD_POOL.length)];
    }

    function renderAdInto(container){
      container.innerHTML = '';
      const ad = pickRandomAd();
      if(ad.type === 'image'){
        const img = document.createElement('img');
        img.src = ad.url; img.alt = 'Ad';
        container.appendChild(img);
      } else {
        const v = document.createElement('video');
        v.src = ad.url; v.controls = true; v.autoplay = true; v.playsInline = true; v.muted = true; // muted untuk bypass blokir autoplay desktop
        container.appendChild(v);
      }
    }

    /* =========================
       IKLAN: +3 KEY (QUICK) ‚Äî dipakai saat kunci habis
       ========================= */
    function watchAdForKeys(onDone){
      const adBox = document.getElementById('adBox');
      const adHint = document.getElementById('adHint');
      const adActions = document.getElementById('adActions');
      const adTimer = document.getElementById('adTimer');
      adBox.innerHTML = ''; adActions.innerHTML = ''; adHint.textContent = ''; adTimer.textContent='';

      renderAdInto(adBox);
      openModal('ad');

      // Quick model: tombol untuk klaim setelah minimal 10 detik
      let left = 10; adTimer.textContent = `Sisa waktu: ${left} detik`;
      const t = setInterval(()=>{
        left--; adTimer.textContent = `Sisa waktu: ${left} detik`;
        if(left<=0){
          clearInterval(t);
          adHint.textContent = 'Klik tombol untuk klaim +3 kunci.';
          const ok = document.createElement('button');
          ok.className = 'btn'; ok.textContent = 'Tutup Iklan & Klaim +3 Kunci';
          ok.onclick = () => { closeModal('ad'); grantKeys(3); onDone && onDone(); alert('Mantap! Kamu mendapatkan +3 kunci.'); };
          adActions.appendChild(ok);
        }
      },1000);
    }

    /* =========================
       IKLAN: PAKET KEY DENGAN DURASI SPESIFIK
       ========================= */
    function startPackageAd(keys, duration){
      const u = getCurrentUserObj(); if(!u){ alert('Silakan login dulu.'); return; }
      closeModal('upgrade');

      const adBox = document.getElementById('adBox');
      const adHint = document.getElementById('adHint');
      const adActions = document.getElementById('adActions');
      const adTimer = document.getElementById('adTimer');
      adBox.innerHTML = ''; adActions.innerHTML = ''; adHint.textContent = ''; adTimer.textContent='';

      renderAdInto(adBox);
      adHint.textContent = `Tonton iklan sampai selesai (${duration} detik) untuk mendapat ${keys} kunci.`;
      openModal('ad');

      let left = duration; adTimer.textContent = `Sisa waktu: ${left} detik`;
      const t = setInterval(()=>{
        left--; adTimer.textContent = `Sisa waktu: ${left} detik`;
        if(left<=0){
          clearInterval(t);
          adHint.textContent = 'Selesai! Kamu bisa klaim kuncimu.';
          const ok = document.createElement('button');
          ok.className = 'btn'; ok.textContent = `Klaim ${keys} Kunci`;
          ok.onclick = () => { closeModal('ad'); grantKeys(keys); alert(`Iklan selesai! Kamu mendapat ${keys} kunci üîë.`); };
          adActions.appendChild(ok);
        }
      },1000);
    }

    function grantKeys(n){
      const u = getCurrentUserObj(); if(!u) return;
      saveCurrentUserObj(prev => ({...prev, keys: (prev.keys||0) + n}));
    }

    function consumeKeyIfBasic(){
      const u = getCurrentUserObj(); if(!u) return false;
      const k = u.keys || 0; if(k <= 0) return false;
      saveCurrentUserObj(prev => ({...prev, keys: (prev.keys||0) - 1}));
      return true;
    }

    /* =========================
       PLAYER & EPISODE FLOW
       ========================= */
    function gantiEpisode(link, judul){
      const player   = document.getElementById('player');
      const titleEl  = document.getElementById('judul');
      player.src = link;
      titleEl.textContent = 'üé¨ ' + judul;
      document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
      document.querySelector('.player').scrollIntoView({behavior:'smooth', block:'start'});
    }

    // Flow: klik episode -> cek login + keys
    function requestPlay(link, judul){
      const user = getCurrentUserObj();
      if(!user){ openAuth(); return; }

      if((user.keys||0) <= 0){
        openModal('need-keys');
        pendingPlay = { link, judul };
        return;
      }

      if(consumeKeyIfBasic()){
        gantiEpisode(link, judul);
      }else{
        openModal('need-keys');
        pendingPlay = { link, judul };
      }
    }

    let pendingPlay = null; // menyimpan episode yang ingin diputar saat kunci habis

    // tombol "Tonton Iklan (+3 kunci)" di modal kunci
    function watchAdForKeysAndContinue(){
      watchAdForKeys(()=> {
        closeModal('need-keys');
        if(pendingPlay){
          if(consumeKeyIfBasic()){
            gantiEpisode(pendingPlay.link, pendingPlay.judul);
            pendingPlay = null;
          }
        }
      });
    }

    // Sambungkan tombol +3 kunci
    const btnWatchAd3 = document.getElementById('btnWatchAd3');
    if(btnWatchAd3){ btnWatchAd3.addEventListener('click', watchAdForKeysAndContinue); }

    // Tutup modal saat klik backdrop / tekan ESC (perbaikan kasus laptop)
    window.addEventListener('click', e=>{ if(e.target.classList.contains('modal')) e.target.style.display='none'; });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }});

    // Search by title/genre (realtime)
    document.getElementById('searchInput').addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      document.querySelectorAll('#animeList .card').forEach(card=>{
        const title = (card.dataset.title||'').toLowerCase();
        const genre = (card.dataset.genre||'').toLowerCase();
        card.classList.toggle('hide', !(title.includes(q) || genre.includes(q)));
      });
    });

    // Init
    renderUserBar();
  </script>
</body>
</html>
